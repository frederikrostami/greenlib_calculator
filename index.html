<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenLIB Black Mass Financial Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F5F5F0;
            color: #1a202c;
            line-height: 1.6;
        }
        
        /* Top Header Bar with Logo */
        .top-header {
            background: white;
            color: #14532D;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-text {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 1px;
            color: #8BC34A;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
            opacity: 0.95;
        }
        
        .divider {
            width: 2px;
            height: 30px;
            background: #8BC34A;
            margin: 0 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 30px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(20, 83, 45, 0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #14532D 0%, #1e6b3d 100%);
            color: white;
            padding: 40px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(139, 195, 74, 0.15) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 12px;
            font-weight: 800;
            letter-spacing: -0.5px;
            position: relative;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 500;
            position: relative;
        }
        
        .tabs {
            display: flex;
            background: #F5F5F0;
            border-bottom: 2px solid #e5e5df;
            padding: 0 20px;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 700;
            border: none;
            background: transparent;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            color: #5a5a52;
        }
        
        .tab:hover {
            background: rgba(139, 195, 74, 0.1);
            color: #14532D;
        }
        
        .tab.active {
            background: white;
            color: #14532D;
            border-bottom-color: #8BC34A;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .input-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
            box-shadow: 0 2px 12px rgba(20, 83, 45, 0.06);
            border-radius: 12px;
            overflow: hidden;
            table-layout: fixed;
        }
        
        .input-table thead { background: #14532D; color: #fff; }
        
        .input-table th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .input-table tbody tr {
            border-bottom: 1px solid #F5F5F0;
            transition: background 0.2s ease;
        }
        
        .input-table tbody tr:hover {
            background: rgba(139, 195, 74, 0.05);
        }
        
        .input-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .input-table td {
            padding: 14px 16px;
            font-size: 14px;
            color: #2d3748;
        }
        
        .input-table tbody td {
            vertical-align: middle;
        }
        
        .input-table td:nth-child(2),
        .input-table th:nth-child(2) {
            text-align: center !important;
            vertical-align: middle;
            width: 25%;
            padding: 14px 10px !important;
        }
        
        .input-table td:nth-child(1),
        .input-table th:nth-child(1) {
            text-align: left !important;
            vertical-align: middle;
            width: 35%;
        }
        
        .input-table td:nth-child(3),
        .input-table th:nth-child(3) {
            width: 25%;
        }
        
        .input-table td:nth-child(4),
        .input-table th:nth-child(4) {
            text-align: center !important;
            vertical-align: middle;
            width: 15%;
        }
        
        .input-table input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #d1fae5;
            background: #f0fdf4;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: right;
            transition: all 0.3s ease;
            color: #14532D;
        }
        
        .input-table input:focus {
            outline: none;
            border-color: #8BC34A;
            background: white;
            box-shadow: 0 0 0 4px rgba(139, 195, 74, 0.15);
            transform: scale(1.01);
        }
        
        .section-title {
            background: linear-gradient(135deg, #14532D 0%, #1e6b3d 100%);
            color: white;
            padding: 14px 24px;
            font-weight: 800;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin: 30px 0 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(20, 83, 45, 0.15);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 30px;
        }
        
        .result-card {
            background: white;
            border: 2px solid #e5e5df;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(20, 83, 45, 0.06);
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            box-shadow: 0 4px 20px rgba(20, 83, 45, 0.12);
            transform: translateY(-2px);
        }
        
        .result-card-header {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 20px;
            color: #14532D;
            padding-bottom: 12px;
            border-bottom: 3px solid #8BC34A;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-card.greenlib .result-card-header {
            color: #14532D;
        }
        
        .result-card.export .result-card-header {
            color: #5a5a52;
        }
        
        .result-table {
            width: 100%;
            font-size: 14px;
        }
        
        .result-table tr {
            border-bottom: 1px solid #F5F5F0;
        }
        
        .result-table tr:last-child {
            border-bottom: none;
        }
        
        .result-table td {
            padding: 10px 0;
        }
        
        .result-table td:last-child {
            text-align: right;
            font-weight: 700;
            color: #14532D;
        }
        
        .result-table tr:last-child td {
            padding-top: 15px;
            font-size: 16px;
        }
        
        .improvement-banner {
            background: linear-gradient(135deg, #14532D 0%, #1e6b3d 100%);
            color: white;
            padding: 32px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 4px 20px rgba(20, 83, 45, 0.2);
        }
        
        .improvement-banner h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .improvement-amount {
            font-size: 48px;
            font-weight: 900;
            color: #8BC34A;
            margin: 16px 0;
            letter-spacing: -1px;
        }
        
        .improvement-details {
            font-size: 15px;
            line-height: 1.8;
            opacity: 0.95;
        }
        
        .improvement-details p {
            margin: 8px 0;
        }
        
        .esg-card {
            background: linear-gradient(135deg, #8BC34A 0%, #9ed654 100%);
            color: white;
            padding: 32px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 4px 20px rgba(139, 195, 74, 0.25);
        }
        
        .esg-card h3 {
            font-size: 20px;
            margin-bottom: 24px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .esg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .esg-metric {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .esg-metric-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .esg-metric-value {
            font-size: 24px;
            font-weight: 800;
            margin: 8px 0;
        }
        
        .esg-metric-label {
            font-size: 12px;
            opacity: 0.95;
            line-height: 1.4;
        }
        
        .projection-card {
            background: white;
            border: 2px solid #e5e5df;
            border-radius: 12px;
            padding: 32px;
            margin: 30px 0;
            box-shadow: 0 2px 12px rgba(20, 83, 45, 0.06);
        }
        
        .projection-card h3 {
            color: #14532D;
            font-size: 20px;
            margin-bottom: 24px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .projection-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .projection-table thead { background: #14532D; color: #fff; }
        
        .projection-table th {
            padding: 14px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .projection-table tbody tr {
            border-bottom: 1px solid #F5F5F0;
        }
        
        .projection-table tbody tr:hover {
            background: rgba(139, 195, 74, 0.05);
        }
        
        .projection-table tbody tr:last-child {
            background: #f0fdf4;
            font-weight: 800;
            border-top: 3px solid #8BC34A;
        }
        
        .projection-table td {
            padding: 12px 14px;
            font-size: 14px;
        }
        
        .price-scenarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .scenario-card {
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .scenario-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.15);
        }
        
        .scenario-card h4 {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scenario-card.bear {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
        }
        
        .scenario-card.bear h4 {
            color: #92400e;
        }
        
        .scenario-card.base {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #60a5fa;
        }
        
        .scenario-card.base h4 {
            color: #1e40af;
        }
        
        .scenario-card.bull {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #8BC34A;
        }
        
        .scenario-card.bull h4 {
            color: #14532D;
        }
        
        .scenario-metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .scenario-metric:last-child {
            border-bottom: none;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(0,0,0,0.2);
            font-weight: 800;
            font-size: 15px;
        }
        
        .profit-share-card {
            background: white;
            border: 2px solid #e5e5df;
            border-radius: 12px;
            padding: 32px;
            margin: 30px 0;
            box-shadow: 0 2px 12px rgba(20, 83, 45, 0.06);
        }
        
        .profit-share-card h3 {
            color: #14532D;
            font-size: 20px;
            margin-bottom: 24px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .profit-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .profit-split-item {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #d1fae5;
        }
        
        .profit-split-label {
            font-size: 13px;
            color: #5a5a52;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .profit-split-value {
            font-size: 28px;
            font-weight: 800;
            color: #14532D;
        }
        
        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .price-scenarios {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .divider {
                display: none;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .profit-split {
                grid-template-columns: 1fr;
            }
        }
    
        .calculate-btn {
            background: linear-gradient(135deg, #8BC34A 0%, #9ed654 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(139, 195, 74, 0.3);
            transition: all 0.3s ease;
            margin: 30px 0;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .calculate-btn:hover {
            background: linear-gradient(135deg, #9ed654 0%, #8BC34A 100%);
            box-shadow: 0 6px 20px rgba(139, 195, 74, 0.4);
            transform: translateY(-2px);
        }
        
        .calculate-btn:active {
            transform: translateY(0);
        }
    
/* Added styles */
.tariff-banner {
  background: #fff7ed;
  border: 2px solid #fbbf24;
  color: #78350f;
  padding: 14px 16px;
  border-radius: 10px;
  margin: 16px 0;
  font-weight: 700;
}

.toast {
  background: #14532D;
  color: #fff;
  padding: 12px 16px;
  margin-top: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  transition: all .3s ease;
  font-weight: 700;
}
.toast.error { background: #7f1d1d; }
.toast.info  { background: #1e40af; }

/* Make hidden panels not consume layout */
.section[hidden] { display: none !important; }

    </style>
</head>
<body>
    <!-- Top Header with Logo -->
    <div class="top-header">
        <div class="logo-container">
            <img src="greenlib_calculator_assets/logo.png" alt="GreenLIB" class="logo-img" loading="lazy" decoding="async" width="160" height="40" style="height:40px;width:auto">
            <div class="divider"></div>
            <div class="header-title">BLACK MASS FINANCIAL CALCULATOR</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Value Comparison Tool</h1>
            <p>Compare realization values across processing routes with real-time adjustable inputs</p>
        </div>
        
        <div class="tabs" role="tablist" aria-label="Scenario Tabs">
    <button class="tab active" role="tab" aria-selected="true" aria-controls="us1" id="tab-us1" tabindex="0">US Scenario 1</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="us2" id="tab-us2" tabindex="-1">US Scenario 2</button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="eu"  id="tab-eu"  tabindex="-1">EU Scenario</button>
</div>
<div class="content">
            <!-- US Scenario 1 -->
            <div id="us1" class="section active" role="tabpanel" aria-labelledby="tab-us1">
                <div class="section-title">METAL PRICES ($/t)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Metal</th>
                            <th style="width: 25%; text-align: center;">Benchmark</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nickel (LME)</td>
                            <td>$15,000-20,000/t</td>
                            <td><input type="number" id="us1-ni-price" value="15000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Cobalt (MB Standard)</td>
                            <td>$40,000-50,000/t</td>
                            <td><input type="number" id="us1-co-price" value="42000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Lithium Carbonate (Technical Grade)</td>
                            <td>$6,000-10,000/t</td>
                            <td><input type="number" id="us1-li-price" value="7000" step="100"></td>
                            <td>$/t Li₂CO₃</td>
                        </tr>
                        <tr>
                            <td>Graphite (Recycled Graphite)</td>
                            <td>$1,000-2,000/t</td>
                            <td><input type="number" id="us1-graphite-price" value="1500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Lithium Fluoride (LiF)</td>
                            <td>$4,000-6,000/t</td>
                            <td><input type="number" id="us1-lif-price" value="5000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Aluminum</td>
                            <td>$2,000-3,000/t</td>
                            <td><input type="number" id="us1-al-price" value="2500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Copper</td>
                            <td>$5,000-6,000/t</td>
                            <td><input type="number" id="us1-cu-price" value="5500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">FEED COMPOSITION (%)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th style="width: 25%; text-align: center;">Typical Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nickel (Ni)</td>
                            <td>10-25%</td>
                            <td><input type="number" id="us1-ni-content" value="15" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Cobalt (Co)</td>
                            <td>5-15%</td>
                            <td><input type="number" id="us1-co-content" value="8" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Lithium (Li)</td>
                            <td>3-8%</td>
                            <td><input type="number" id="us1-li-content" value="5" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Carbon (C)</td>
                            <td>30-40%</td>
                            <td><input type="number" id="us1-c-content" value="35" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Fluorine (F)</td>
                            <td>0.5-2%</td>
                            <td><input type="number" id="us1-f-content" value="1" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Aluminum (Al)</td>
                            <td>3-8%</td>
                            <td><input type="number" id="us1-al-content" value="5" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Copper (Cu)</td>
                            <td>1-3%</td>
                            <td><input type="number" id="us1-cu-content" value="2" step="0.1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">RECOVERY RATES (%)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Process Stream</th>
                            <th style="width: 25%; text-align: center;">Recovery Targets</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ni/Co Recovery</td>
                            <td>>99%</td>
                            <td><input type="number" id="us1-nico-recovery" value="93" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Lithium Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="us1-li-recovery" value="90" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Carbon Recovery</td>
                            <td>>95%</td>
                            <td><input type="number" id="us1-c-recovery" value="85" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Fluorine Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="us1-f-recovery" value="80" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Al/Cu Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="us1-alcu-recovery" value="85" step="0.1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">PROCESSING PARAMETERS</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th style="width: 25%; text-align: center;">Typical Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>GreenLIB Processing Fee</td>
                            <td>$700-1,400/t</td>
                            <td><input type="number" id="us1-processing-fee" value="1050" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Capacity Reservation Fee</td>
                            <td>$100-200/t</td>
                            <td><input type="number" id="us1-capacity-fee" value="150" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>GreenLIB all-in logistics and compliance</td>
                            <td>$140-300/t</td>
                            <td><input type="number" id="us1-greenlib-transport" value="220" step="10"></td>
                            <td>$/t</td>
                        </tr>

                        <tr>
                            <td>Export all-in logistics and compliance (CIF Asia)</td>
                            <td>$600-800/t</td>
                            <td><input type="number" id="us1-export-transport" value="700" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Export Payability (Ni/Co)</td>
                            <td>55-70%</td>
                            <td><input type="number" id="us1-export-payability" value="65" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>GreenLIB Ni/Co Payability</td>
                            <td>80-90%</td>
                            <td><input type="number" id="us1-greenlib-payability" value="85" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Annual Volume</td>
                            <td>1,000-10,000</td>
                            <td><input type="number" id="us1-volume" value="10000" step="100"></td>
                            <td>tonnes/yr</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">CUSMA / TARIFF ANALYSIS</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th style="width: 25%; text-align: center;">Options / Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>CUSMA Qualification</td>
                            <td>Qualified (0% tariff) / Not Qualified</td>
                            <td>
                                <select id="us1-cusma-qualified">
                                    <option value="true">Qualified (0% tariff)</option>
                                    <option value="false">Not Qualified</option>
                                </select>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>Tariff Rate if Not Qualified</td>
                            <td>0-50%</td>
                            <td><input type="number" id="us1-tariff-rate" value="40" step="1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                                
                <button class="calculate-btn" id="btn-us1">🔬 Calculate US Scenario 1</button>
                
                <div id="us1-results"></div>
            </div>
            
            <!-- US Scenario 2 -->
            <div id="us2" class="section" role="tabpanel" aria-labelledby="tab-us2" hidden>
                <div class="section-title">METAL PRICES ($/t)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Metal</th>
                            <th style="width: 25%; text-align: center;">Benchmark</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nickel (LME)</td>
                            <td>$15,000-20,000/t</td>
                            <td><input type="number" id="us2-ni-price" value="15000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Cobalt (MB Standard)</td>
                            <td>$40,000-50,000/t</td>
                            <td><input type="number" id="us2-co-price" value="42000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Lithium Carbonate (Technical Grade)</td>
                            <td>$6,000-10,000/t</td>
                            <td><input type="number" id="us2-li-price" value="7000" step="100"></td>
                            <td>$/t Li₂CO₃</td>
                        </tr>
                        <tr>
                            <td>Graphite (Recycled Graphite)</td>
                            <td>$1,000-2,000/t</td>
                            <td><input type="number" id="us2-graphite-price" value="1500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Lithium Fluoride (LiF)</td>
                            <td>$4,000-6,000/t</td>
                            <td><input type="number" id="us2-lif-price" value="5000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Aluminum</td>
                            <td>$2,000-3,000/t</td>
                            <td><input type="number" id="us2-al-price" value="2500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Copper</td>
                            <td>$5,000-6,000/t</td>
                            <td><input type="number" id="us2-cu-price" value="5500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">FEED COMPOSITION (%)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th style="width: 25%; text-align: center;">Typical Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nickel (Ni)</td>
                            <td>10-25%</td>
                            <td><input type="number" id="us2-ni-content" value="15" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Cobalt (Co)</td>
                            <td>5-15%</td>
                            <td><input type="number" id="us2-co-content" value="8" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Lithium (Li)</td>
                            <td>3-8%</td>
                            <td><input type="number" id="us2-li-content" value="5" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Carbon (C)</td>
                            <td>30-40%</td>
                            <td><input type="number" id="us2-c-content" value="35" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Fluorine (F)</td>
                            <td>0.5-2%</td>
                            <td><input type="number" id="us2-f-content" value="1" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Aluminum (Al)</td>
                            <td>3-8%</td>
                            <td><input type="number" id="us2-al-content" value="5" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Copper (Cu)</td>
                            <td>1-3%</td>
                            <td><input type="number" id="us2-cu-content" value="2" step="0.1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">RECOVERY RATES (%)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Process Stream</th>
                            <th style="width: 25%; text-align: center;">Recovery Targets</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ni/Co Recovery</td>
                            <td>>99%</td>
                            <td><input type="number" id="us2-nico-recovery" value="93" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Lithium Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="us2-li-recovery" value="90" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Carbon Recovery</td>
                            <td>>95%</td>
                            <td><input type="number" id="us2-c-recovery" value="85" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Fluorine Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="us2-f-recovery" value="80" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Al/Cu Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="us2-alcu-recovery" value="85" step="0.1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">PROCESSING PARAMETERS</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th style="width: 25%; text-align: center;">Typical Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>GreenLIB Processing Fee</td>
                            <td>$700-1,400/t</td>
                            <td><input type="number" id="us2-processing-fee" value="1050" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Capacity Reservation Fee</td>
                            <td>$100-200/t</td>
                            <td><input type="number" id="us2-capacity-fee" value="150" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>GreenLIB all-in logistics and compliance</td>
                            <td>$140-300/t</td>
                            <td><input type="number" id="us2-greenlib-transport" value="220" step="10"></td>
                            <td>$/t</td>
                        </tr>

                        <tr>
                            <td>Export all-in logistics and compliance (CIF Asia)</td>
                            <td>$600-800/t</td>
                            <td><input type="number" id="us2-export-transport" value="700" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Export Payability (Ni/Co)</td>
                            <td>55-70%</td>
                            <td><input type="number" id="us2-export-payability" value="65" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>GreenLIB Ni/Co Payability</td>
                            <td>80-90%</td>
                            <td><input type="number" id="us2-greenlib-payability" value="85" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Profit Share to Customer</td>
                            <td>50-80%</td>
                            <td><input type="number" id="us2-profit-share" value="70" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Annual Volume</td>
                            <td>1,000-10,000</td>
                            <td><input type="number" id="us2-volume" value="10000" step="100"></td>
                            <td>tonnes/yr</td>
                        </tr>
                    </tbody>
                </table>
                
                                
                <button class="calculate-btn" id="btn-us2">🔬 Calculate US Scenario 2</button>
                
                <div id="us2-results"></div>
            </div>
            
            <!-- EU Scenario -->
            <div id="eu" class="section" role="tabpanel" aria-labelledby="tab-eu" hidden>
                <div class="section-title">METAL PRICES ($/t)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Metal</th>
                            <th style="width: 25%; text-align: center;">Benchmark</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nickel (LME)</td>
                            <td>$15,000-20,000/t</td>
                            <td><input type="number" id="eu-ni-price" value="15000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Cobalt (MB Standard)</td>
                            <td>$40,000-50,000/t</td>
                            <td><input type="number" id="eu-co-price" value="42000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Lithium Carbonate (Technical Grade)</td>
                            <td>$6,000-10,000/t</td>
                            <td><input type="number" id="eu-li-price" value="7000" step="100"></td>
                            <td>$/t Li₂CO₃</td>
                        </tr>
                        <tr>
                            <td>Graphite (Recycled Graphite)</td>
                            <td>$1,000-2,000/t</td>
                            <td><input type="number" id="eu-graphite-price" value="1500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Lithium Fluoride (LiF)</td>
                            <td>$4,000-6,000/t</td>
                            <td><input type="number" id="eu-lif-price" value="5000" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Aluminum</td>
                            <td>$2,000-3,000/t</td>
                            <td><input type="number" id="eu-al-price" value="2500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Copper</td>
                            <td>$5,000-6,000/t</td>
                            <td><input type="number" id="eu-cu-price" value="5500" step="100"></td>
                            <td>$/t</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">FEED COMPOSITION (%)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th style="width: 25%; text-align: center;">Typical Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Nickel (Ni)</td>
                            <td>10-25%</td>
                            <td><input type="number" id="eu-ni-content" value="15" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Cobalt (Co)</td>
                            <td>5-15%</td>
                            <td><input type="number" id="eu-co-content" value="8" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Lithium (Li)</td>
                            <td>3-8%</td>
                            <td><input type="number" id="eu-li-content" value="5" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Carbon (C)</td>
                            <td>30-40%</td>
                            <td><input type="number" id="eu-c-content" value="35" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Fluorine (F)</td>
                            <td>0.5-2%</td>
                            <td><input type="number" id="eu-f-content" value="1" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Aluminum (Al)</td>
                            <td>3-8%</td>
                            <td><input type="number" id="eu-al-content" value="5" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Copper (Cu)</td>
                            <td>1-3%</td>
                            <td><input type="number" id="eu-cu-content" value="2" step="0.1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">RECOVERY RATES (%)</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Process Stream</th>
                            <th style="width: 25%; text-align: center;">Recovery Targets</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ni/Co Recovery</td>
                            <td>>99%</td>
                            <td><input type="number" id="eu-nico-recovery" value="93" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Lithium Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="eu-li-recovery" value="90" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Carbon Recovery</td>
                            <td>>95%</td>
                            <td><input type="number" id="eu-c-recovery" value="85" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Fluorine Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="eu-f-recovery" value="80" step="0.1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Al/Cu Recovery</td>
                            <td>>90%</td>
                            <td><input type="number" id="eu-alcu-recovery" value="85" step="0.1"></td>
                            <td>%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="section-title">PROCESSING PARAMETERS</div>
                <table class="input-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th style="width: 25%; text-align: center;">Typical Range</th>
                            <th style="width: 25%;">Input Value</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>GreenLIB Processing Fee</td>
                            <td>$700-1,400/t</td>
                            <td><input type="number" id="eu-processing-fee" value="1050" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Capacity Reservation Fee</td>
                            <td>$100-200/t</td>
                            <td><input type="number" id="eu-capacity-fee" value="150" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>GreenLIB all-in logistics and compliance</td>
                            <td>$100-200/t</td>
                            <td><input type="number" id="eu-greenlib-transport" value="150" step="10"></td>
                            <td>$/t</td>
                        </tr>

                        <tr>
                            <td>Export all-in logistics and compliance (CIF Asia)</td>
                            <td>$600-800/t</td>
                            <td><input type="number" id="eu-export-transport" value="700" step="10"></td>
                            <td>$/t</td>
                        </tr>
                        <tr>
                            <td>Export Payability (Ni/Co)</td>
                            <td>55-70%</td>
                            <td><input type="number" id="eu-export-payability" value="65" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>GreenLIB Ni/Co Payability</td>
                            <td>80-90%</td>
                            <td><input type="number" id="eu-greenlib-payability" value="85" step="1"></td>
                            <td>%</td>
                        </tr>
                        <tr>
                            <td>Annual Volume</td>
                            <td>1,000-10,000</td>
                            <td><input type="number" id="eu-volume" value="10000" step="100"></td>
                            <td>tonnes/yr</td>
                        </tr>
                    </tbody>
                </table>
                
                                
                <button class="calculate-btn" id="btn-eu">🔬 Calculate EU Scenario</button>
                
                <div id="eu-results"></div>
            </div>
        </div>
    </div>

    
<script>
(() => {
  'use strict';

  // ====== Formatters ======
  const fmtUSD0 = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
  const fmtNUM0 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
  const usd0 = (n) => fmtUSD0.format(Math.round(n || 0));
  const num0 = (n) => fmtNUM0.format(Math.round(n || 0));

  // ====== Safe numeric getters ======
  function num(id, { min = -Infinity, max = Infinity, fallback = 0 } = {}) {
    const el = document.getElementById(id);
    let v = parseFloat(el && el.value);
    if (Number.isNaN(v)) v = fallback;
    if (!Number.isFinite(v)) v = fallback;
    v = Math.min(Math.max(v, min), max);
    if (el && el.value !== String(v)) el.value = v;
    return v;
  }
  const pctVal = (id) => num(id, { min: 0, max: 100, fallback: 0 }) / 100;

  // ====== Accessibility helpers ======
  function addAriaLabels() {
    document.querySelectorAll('table.input-table tbody tr').forEach(tr => {
      const labelCell = tr.querySelector('td:first-child, th[scope="row"]');
      const input = tr.querySelector('input, select');
      if (labelCell && input) input.setAttribute('aria-label', labelCell.textContent.trim());
    });
  }
  function applyPercentConstraints() {
    document.querySelectorAll('input[id*="-content"], input[id*="-recovery"], input[id*="-payability"], #us2-profit-share').forEach(el => {
      el.setAttribute('min', '0'); el.setAttribute('max', '100');
    });
    document.querySelectorAll('input[type="number"]').forEach(el => {
      if (!el.hasAttribute('min')) el.setAttribute('min', '0');
    });
  }

  // ====== Local storage ======
  const LS_KEY = 'greenlib_calc_v2';
  function saveInputs() {
    const data = {};
    document.querySelectorAll('input[type="number"], select').forEach(el => { data[el.id] = el.value; });
    try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
  }
  function loadInputs() {
    try {
      const raw = localStorage.getItem(LS_KEY); if (!raw) return;
      const data = JSON.parse(raw);
      Object.entries(data).forEach(([id, val]) => { const el = document.getElementById(id); if (el) el.value = val; });
    } catch {}
  }

  // ====== Toast notification ======
  function toast(msg, type='warn', timeout=4000) {
    const wrap = document.getElementById('toast-wrap') || (() => {
      const d = document.createElement('div');
      d.id = 'toast-wrap';
      d.style.position = 'fixed'; d.style.top = '16px'; d.style.right = '16px'; d.style.zIndex = '9999';
      document.body.appendChild(d); return d;
    })();
    const card = document.createElement('div');
    card.className = 'toast ' + type;
    card.textContent = msg;
    wrap.appendChild(card);
    setTimeout(() => { card.style.opacity = '0'; card.style.transform = 'translateY(-6px)'; setTimeout(() => card.remove(), 400); }, timeout);
  }

  // ====== Composition sanity check ======
  function checkComposition(prefix) {
    const sum = ['ni','co','li','c','f','al','cu']
      .map(k => num(`${prefix}-${k}-content`, { min:0, max:100, fallback:0 }))
      .reduce((a,b)=>a+b,0);
    if (sum > 100.01) {
      toast(`${prefix.toUpperCase()}: Feed composition sums to ${sum.toFixed(1)}%. Please verify. Calculations proceed with entered values.`, 'error', 6000);
    }
    return sum;
  }

  // ====== Read all inputs by prefix ======
  function readParams(prefix) {
    const prices = {
      ni: num(`${prefix}-ni-price`, { min:0 }),
      co: num(`${prefix}-co-price`, { min:0 }),
      li: num(`${prefix}-li-price`, { min:0 }),
      graphite: num(`${prefix}-graphite-price`, { min:0 }),
      lif: num(`${prefix}-lif-price`, { min:0 }),
      al: num(`${prefix}-al-price`, { min:0 }),
      cu: num(`${prefix}-cu-price`, { min:0 }),
    };
    const content = {
      ni: pctVal(`${prefix}-ni-content`),
      co: pctVal(`${prefix}-co-content`),
      li: pctVal(`${prefix}-li-content`),
      c:  pctVal(`${prefix}-c-content`),
      f:  pctVal(`${prefix}-f-content`),
      al: pctVal(`${prefix}-al-content`),
      cu: pctVal(`${prefix}-cu-content`),
    };
    const recovery = {
      nico: pctVal(`${prefix}-nico-recovery`),
      li:   pctVal(`${prefix}-li-recovery`),
      c:    pctVal(`${prefix}-c-recovery`),
      f:    pctVal(`${prefix}-f-recovery`),
      alcu: pctVal(`${prefix}-alcu-recovery`),
    };
    const fees = {
      processing: num(`${prefix}-processing-fee`, { min:0 }),
      capacity:   num(`${prefix}-capacity-fee`, { min:0 }),
      greenlibTransport: num(`${prefix}-greenlib-transport`, { min:0 }),
    };
    const exportParams = {
      transport: num(`${prefix}-export-transport`, { min:0 }),
      payability: pctVal(`${prefix}-export-payability`),
    };
    const greenlibPayability = pctVal(`${prefix}-greenlib-payability`);
    const volume = num(`${prefix}-volume`, { min:0 });
    return { prices, content, recovery, fees, exportParams, greenlibPayability, volume };
  }

  // ====== Core math (DRY) ======
  function greenlibGrossAt({ prices, content, recovery, greenlibPayability }) {
    const ni = content.ni * recovery.nico * greenlibPayability * prices.ni;
    const co = content.co * recovery.nico * greenlibPayability * prices.co;
    const li = content.li * recovery.li * 5.32 * prices.li;        // Li -> Li2CO3
    const graph = content.c * recovery.c * prices.graphite;
    const lif  = content.f * recovery.f * 1.365 * prices.lif;      // F  -> LiF
    const al   = content.al * recovery.alcu * prices.al;
    const cu   = content.cu * recovery.alcu * prices.cu;
    return { ni, co, li, graph, lif, al, cu, gross: ni+co+li+graph+lif+al+cu };
  }
  function greenlibNetAt(gross, fees, tariff=0) {
    return gross - fees.processing - fees.capacity - fees.greenlibTransport - tariff;
  }
  function exportNetAt({ content, prices, exportParams }) {
    const niV = content.ni * exportParams.payability * prices.ni;
    const coV = content.co * exportParams.payability * prices.co;
    const gross = niV + coV;
    return { niV, coV, gross, net: gross - exportParams.transport };
  }

  // ====== Tabs (accessible) ======
  function initTabs() {
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.section');
    function activate(targetId) {
      tabs.forEach(t => {
        const sel = t.getAttribute('aria-controls') === targetId;
        t.classList.toggle('active', sel);
        t.setAttribute('aria-selected', sel ? 'true' : 'false');
        t.setAttribute('tabindex', sel ? '0' : '-1');
      });
      panels.forEach(p => {
        const sel = p.id === targetId;
        p.classList.toggle('active', sel);
        if (sel) p.removeAttribute('hidden'); else p.setAttribute('hidden', '');
      });
    }
    tabs.forEach(t => {
      t.addEventListener('click', () => activate(t.getAttribute('aria-controls')));
      t.addEventListener('keydown', e => {
        const idx = [...tabs].indexOf(t);
        if (e.key === 'ArrowRight') tabs[(idx+1) % tabs.length].focus();
        if (e.key === 'ArrowLeft')  tabs[(idx-1+tabs.length) % tabs.length].focus();
        if (e.key === 'Home') tabs[0].focus();
        if (e.key === 'End')  tabs[tabs.length-1].focus();
        if (e.key === 'Enter' || e.key === ' ') activate(t.getAttribute('aria-controls'));
      });
    });
  }

  // ====== Results builders ======
  function buildUS1Results(state) {
    const { prices, content, recovery, fees, exportParams, greenlibPayability, volume } = state;
    const gl = greenlibGrossAt({ prices, content, recovery, greenlibPayability });
    const cusmaQualified = document.getElementById('us1-cusma-qualified').value === 'true';
    const tariffRate = num('us1-tariff-rate', { min: 0, max: 100, fallback: 0 }) / 100;
    const tariffAmt = cusmaQualified ? 0 : gl.gross * tariffRate;
    const glNet = greenlibNetAt(gl.gross, fees, tariffAmt);
    const ex = exportNetAt({ content, prices, exportParams });
    const improvement = glNet - ex.net;
    const improvementPct = ex.net > 0 ? (improvement / ex.net * 100) : NaN;
    const totalImprovement = improvement * volume;

    const scen = {
      bear: { ni:12000, co:30000, li:5000 },
      base: { ni:prices.ni, co:prices.co, li:prices.li },
      bull: { ni:20000, co:55000, li:12000 }
    };
    function scenValues({ ni, co, li }) {
      const prices2 = { ...prices, ni, co, li };
      const gl2 = greenlibGrossAt({ prices: prices2, content, recovery, greenlibPayability });
      const tariff2 = cusmaQualified ? 0 : gl2.gross * tariffRate;
      const net2 = greenlibNetAt(gl2.gross, fees, tariff2);
      const ex2 = exportNetAt({ content, prices: prices2, exportParams });
      return { net: net2, exportNet: ex2.net };
    }
    const sv = { bear:scenValues(scen.bear), base:{ net: glNet, exportNet: ex.net }, bull:scenValues(scen.bull) };

    const tariffRow = \`
      <tr>
        <td>  \${cusmaQualified ? '(Qualified - 0%)' : '(Not Qualified - ' + (tariffRate*100).toFixed(0) + '%)'}</td>
        <td>-\${usd0(tariffAmt)}/t</td>
      </tr>\`;

    const formulaDetails = \`
<details class="formula-details"><summary>Show formulas</summary>
<pre>
GreenLIB gross = Ni*R_nico*P_gl + Co*R_nico*P_gl + Li*(R_li*5.32)*LiPrice
               + C*R_c*GraphitePrice + F*(R_f*1.365)*LiFPrice + Al*R_alcu*AlPrice + Cu*R_alcu*CuPrice

GreenLIB net = gross - Processing - Capacity - Logistics - Tariff (if Not CUSMA)

Export net = (Ni*Pay_export*NiPrice + Co*Pay_export*CoPrice) - Export Logistics

Improvement / t = GL net - Export net
Annual benefit = Improvement / t * Volume
</pre>
</details>\`;

    return \`
      <div class="section-title">COMPARATIVE ANALYSIS</div>
      <div class="results-grid">
        <div class="result-card greenlib">
          <div class="result-card-header">🔬 GREENLIB ROUTE (CUSMA)</div>
          <table class="result-table">
            <tr><td>Ni Value (\${(recovery.nico*100).toFixed(0)}% recovery, \${(greenlibPayability*100).toFixed(0)}% payable)</td><td>\${usd0(gl.ni)}/t</td></tr>
            <tr><td>Co Value (\${(recovery.nico*100).toFixed(0)}% recovery, \${(greenlibPayability*100).toFixed(0)}% payable)</td><td>\${usd0(gl.co)}/t</td></tr>
            <tr><td>Li₂CO₃ Value (\${(recovery.li*100).toFixed(0)}% recovery)</td><td>\${usd0(gl.li)}/t</td></tr>
            <tr><td>Graphite Value (\${(recovery.c*100).toFixed(0)}% recovery)</td><td>\${usd0(gl.graph)}/t</td></tr>
            <tr><td>LiF + Al/Cu Value</td><td>\${usd0(gl.lif + gl.al + gl.cu)}/t</td></tr>
            <tr><td><strong>Gross Product Value</strong></td><td><strong>\${usd0(gl.gross)}/t</strong></td></tr>
            <tr><td>Processing Fee</td><td>-\${usd0(fees.processing)}/t</td></tr>
            <tr><td>Capacity Reservation</td><td>-\${usd0(fees.capacity)}/t</td></tr>
            <tr><td>All-in logistics and compliance</td><td>-\${usd0(fees.greenlibTransport)}/t</td></tr>
            \${tariffRow}
            <tr><td><strong>NET REALIZATION</strong></td><td><strong>\${usd0(glNet)}/t</strong></td></tr>
          </table>
        </div>
        <div class="result-card export">
          <div class="result-card-header">📦 EXPORT ROUTE (BASELINE)</div>
          <table class="result-table">
            <tr><td>Ni Value (\${(exportParams.payability*100).toFixed(0)}% payable)</td><td>\${usd0(ex.niV)}/t</td></tr>
            <tr><td>Co Value (\${(exportParams.payability*100).toFixed(0)}% payable)</td><td>\${usd0(ex.coV)}/t</td></tr>
            <tr><td>Li₂CO₃ / Graphite / Others</td><td>\${usd0(0)}/t</td></tr>
            <tr><td><strong>Gross Product Value</strong></td><td><strong>\${usd0(ex.gross)}/t</strong></td></tr>
            <tr><td>All-in logistics and compliance (CIF Asia)</td><td>-\${usd0(exportParams.transport)}/t</td></tr>
            <tr><td><strong>NET REALIZATION</strong></td><td><strong>\${usd0(ex.net)}/t</strong></td></tr>
          </table>
        </div>
      </div>

      \${!cusmaQualified ? \`<div class="tariff-banner"><strong>⚠️ CUSMA NOT QUALIFIED — TARIFF APPLIED</strong><br>Tariff rate \${(tariffRate*100).toFixed(0)}% adds \${usd0(tariffAmt)}/t to costs and is included in GreenLIB net.</div>\` : ''}

      <div class="improvement-banner">
        <h2>💰 VALUE ENHANCEMENT</h2>
        <div class="improvement-amount">\${usd0(improvement)} per tonne</div>
        <div class="improvement-details">
          <p><strong>Total Annual Benefit:</strong> \${usd0(totalImprovement)} (\${num0(volume)} tonnes)</p>
          <p><strong>Improvement:</strong> \${Number.isFinite(improvementPct) ? improvementPct.toFixed(1) + '%' : 'N/A'} vs Asia Export</p>
        </div>
      </div>

      <div class="projection-card">
        <h3>📈 5-YEAR CUMULATIVE FINANCIAL PROJECTION</h3>
        <table class="projection-table">
          <thead><tr><th>Year</th><th>Annual Volume (tonnes)</th><th>Improvement per Tonne</th><th>Annual Benefit</th><th>Cumulative Benefit</th></tr></thead>
          <tbody>
            \${[1,2,3,4,5].map(i => \`<tr><td>Year \${i}</td><td>\${num0(volume)}</td><td>\${usd0(improvement)}</td><td>\${usd0(totalImprovement)}</td><td>\${usd0(totalImprovement*i)}</td></tr>\`).join('')}
            <tr><td><strong>TOTAL 5-YEAR BENEFIT</strong></td><td colspan="3"></td><td><strong>\${usd0(totalImprovement*5)}</strong></td></tr>
          </tbody>
        </table>
      </div>

      <div class="price-scenarios">
        \${['bear','base','bull'].map(name => {
          const scenMap = { bear:{ni:12000,co:30000,li:5000}, base:{ni:prices.ni,co:prices.co,li:prices.li}, bull:{ni:20000,co:55000,li:12000} };
          const label = name==='bear' ? '🐻 BEAR CASE' : (name==='base' ? '📊 BASE CASE' : '🚀 BULL CASE');
          const s = scenMap[name];
          const prices2 = { ...prices, ni:s.ni, co:s.co, li:s.li };
          const gl2 = greenlibGrossAt({ prices: prices2, content, recovery, greenlibPayability });
          const tariff2 = cusmaQualified ? 0 : gl2.gross * tariffRate;
          const net2 = greenlibNetAt(gl2.gross, fees, tariff2);
          const ex2 = exportNetAt({ content, prices: prices2, exportParams });
          return \`<div class="scenario-card \${name}">
            <h4>\${label}</h4>
            <div class="scenario-metric"><span>Ni:</span><span>\${usd0(s.ni)}/t</span></div>
            <div class="scenario-metric"><span>Co:</span><span>\${usd0(s.co)}/t</span></div>
            <div class="scenario-metric"><span>Li:</span><span>\${usd0(s.li)}/t</span></div>
            <div class="scenario-metric"><span>GreenLIB Net:</span><span>\${usd0(net2)}/t</span></div>
            <div class="scenario-metric"><span>Export Net:</span><span>\${usd0(ex2.net)}/t</span></div>
          </div>\`;
        }).join('')}
      </div>

      \${formulaDetails}
    \`;
  }

  function buildUS2Results(state) {
    const { prices, content, recovery, fees, exportParams, greenlibPayability, volume } = state;
    const gl = greenlibGrossAt({ prices, content, recovery, greenlibPayability });
    const glNet = greenlibNetAt(gl.gross, fees, 0);
    const ex = exportNetAt({ content, prices, exportParams });
    const uplift = glNet - ex.net;
    const profitSharePct = pctVal('us2-profit-share');
    const customerPerT = (uplift * profitSharePct + ex.net);
    const greenlibPerT = (uplift * (1 - profitSharePct));
    const annualCustomer = customerPerT * volume;

    const scen = { bear:{ni:12000, co:30000, li:5000}, base:{ni:prices.ni, co:prices.co, li:prices.li}, bull:{ni:20000, co:55000, li:12000} };
    function scenValues({ ni, co, li }) {
      const prices2 = { ...prices, ni, co, li };
      const gl2 = greenlibGrossAt({ prices: prices2, content, recovery, greenlibPayability });
      const net2 = greenlibNetAt(gl2.gross, fees, 0);
      const ex2 = exportNetAt({ content, prices: prices2, exportParams });
      const uplift2 = net2 - ex2.net;
      const custAnnual = (uplift2 * profitSharePct + ex2.net) * volume;
      return { customerAnnual: custAnnual };
    }
    const sv = { bear:scenValues(scen.bear), base:{ customerAnnual: annualCustomer }, bull:scenValues(scen.bull) };

    const formulaDetails = \`
<details class="formula-details"><summary>Show formulas</summary>
<pre>
Uplift / t = GreenLIB_net - Export_net
Customer / t = Export_net + ProfitShare% × Uplift
GreenLIB / t = (1 - ProfitShare%) × Uplift
Annual to Customer = (Customer / t) × Volume
</pre>
</details>\`;

    return \`
      <div class="section-title">COMPARATIVE ANALYSIS</div>
      <div class="results-grid">
        <div class="result-card greenlib">
          <div class="result-card-header">🔬 GREENLIB ROUTE</div>
          <table class="result-table">
            <tr><td>Ni Value (\${(recovery.nico*100).toFixed(0)}% recovery, \${(greenlibPayability*100).toFixed(0)}% payable)</td><td>\${usd0(gl.ni)}/t</td></tr>
            <tr><td>Co Value (\${(recovery.nico*100).toFixed(0)}% recovery, \${(greenlibPayability*100).toFixed(0)}% payable)</td><td>\${usd0(gl.co)}/t</td></tr>
            <tr><td>Li₂CO₃ Value (\${(recovery.li*100).toFixed(0)}% recovery)</td><td>\${usd0(gl.li)}/t</td></tr>
            <tr><td>Graphite Value (\${(recovery.c*100).toFixed(0)}% recovery)</td><td>\${usd0(gl.graph)}/t</td></tr>
            <tr><td>LiF + Al/Cu Value</td><td>\${usd0(gl.lif + gl.al + gl.cu)}/t</td></tr>
            <tr><td><strong>Gross Product Value</strong></td><td><strong>\${usd0(gl.gross)}/t</strong></td></tr>
            <tr><td>Processing Fee</td><td>-\${usd0(fees.processing)}/t</td></tr>
            <tr><td>Capacity Reservation</td><td>-\${usd0(fees.capacity)}/t</td></tr>
            <tr><td>All-in logistics and compliance</td><td>-\${usd0(fees.greenlibTransport)}/t</td></tr>
            <tr><td><strong>NET REALIZATION</strong></td><td><strong>\${usd0(glNet)}/t</strong></td></tr>
          </table>
        </div>
        <div class="result-card export">
          <div class="result-card-header">📦 EXPORT ROUTE (BASELINE)</div>
          <table class="result-table">
            <tr><td>Ni Value (\${(exportParams.payability*100).toFixed(0)}% payable)</td><td>\${usd0(ex.niV)}/t</td></tr>
            <tr><td>Co Value (\${(exportParams.payability*100).toFixed(0)}% payable)</td><td>\${usd0(ex.coV)}/t</td></tr>
            <tr><td><strong>Gross Product Value</strong></td><td><strong>\${usd0(ex.gross)}/t</strong></td></tr>
            <tr><td>All-in logistics and compliance (CIF Asia)</td><td>-\${usd0(exportParams.transport)}/t</td></tr>
            <tr><td><strong>NET REALIZATION</strong></td><td><strong>\${usd0(ex.net)}/t</strong></td></tr>
          </table>
        </div>
      </div>

      <div class="profit-share-card">
        <h3>💼 PROFIT SHARE MODEL (\${(profitSharePct*100).toFixed(0)}% Customer / \${((1-profitSharePct)*100).toFixed(0)}% GreenLIB)</h3>
        <div class="profit-split">
          <div class="profit-split-item">
            <div class="profit-split-label">Customer Gets</div>
            <div class="profit-split-value">\${usd0(customerPerT)}/t</div>
            <p style="margin-top: 10px; font-size: 13px; color: #5a5a52;">Export baseline + \${(profitSharePct*100).toFixed(0)}% of uplift</p>
          </div>
          <div class="profit-split-item">
            <div class="profit-split-label">GreenLIB Gets</div>
            <div class="profit-split-value">\${usd0(greenlibPerT)}/t</div>
            <p style="margin-top: 10px; font-size: 13px; color: #5a5a52;">\${((1-profitSharePct)*100).toFixed(0)}% of uplift</p>
          </div>
        </div>
        <div style="margin-top: 20px; padding: 20px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #8BC34A;">
          <p style="font-size: 14px; color: #14532D;"><strong>Annual Value to Customer:</strong> \${usd0(annualCustomer)} (\${num0(volume)} tonnes/yr)</p>
        </div>
      </div>

      <div class="price-scenarios">
        \${['bear','base','bull'].map(name => {
          const scenMap = { bear:{ni:12000,co:30000,li:5000}, base:{ni:prices.ni,co:prices.co,li:prices.li}, bull:{ni:20000,co:55000,li:12000} };
          const s = scenMap[name];
          const label = name==='bear' ? '🐻 BEAR CASE' : (name==='base' ? '📊 BASE CASE' : '🚀 BULL CASE');
          const prices2 = { ...prices, ni:s.ni, co:s.co, li:s.li };
          const gl2 = greenlibGrossAt({ prices: prices2, content, recovery, greenlibPayability });
          const net2 = greenlibNetAt(gl2.gross, fees, 0);
          const ex2 = exportNetAt({ content, prices: prices2, exportParams });
          const uplift2 = net2 - ex2.net;
          const profitSharePct = pctVal('us2-profit-share');
          const custAnnual = (uplift2 * profitSharePct + ex2.net) * volume;
          return \`<div class="scenario-card \${name}">
            <h4>\${label}</h4>
            <div class="scenario-metric"><span>Ni:</span><span>\${usd0(s.ni)}/t</span></div>
            <div class="scenario-metric"><span>Co:</span><span>\${usd0(s.co)}/t</span></div>
            <div class="scenario-metric"><span>Li:</span><span>\${usd0(s.li)}/t</span></div>
            <div class="scenario-metric"><span>Customer Gets:</span><span>\${usd0(custAnnual)}/yr</span></div>
          </div>\`;
        }).join('')}
      </div>

      \${formulaDetails}
    \`;
  }

  function buildEUResults(state) {
    const { prices, content, recovery, fees, exportParams, greenlibPayability, volume } = state;
    const gl = greenlibGrossAt({ prices, content, recovery, greenlibPayability });
    const glNet = greenlibNetAt(gl.gross, fees, 0);
    const ex = exportNetAt({ content, prices, exportParams });
    const improvement = glNet - ex.net;
    const improvementPct = ex.net > 0 ? (improvement / ex.net * 100) : NaN;
    const totalImprovement = improvement * volume;

    const scen = { bear:{ni:12000, co:30000, li:5000}, base:{ni:prices.ni, co:prices.co, li:prices.li}, bull:{ni:20000, co:55000, li:12000} };
    function scenValues({ ni, co, li }) {
      const prices2 = { ...prices, ni, co, li };
      const gl2 = greenlibGrossAt({ prices: prices2, content, recovery, greenlibPayability });
      const net2 = greenlibNetAt(gl2.gross, fees, 0);
      const ex2 = exportNetAt({ content, prices: prices2, exportParams });
      return { net: net2, exportNet: ex2.net };
    }
    const sv = { bear:scenValues(scen.bear), base:{ net: glNet, exportNet: ex.net }, bull:scenValues(scen.bull) };

    const formulaDetails = \`
<details class="formula-details"><summary>Show formulas</summary>
<pre>Same as US1 but without CUSMA tariff term.</pre>
</details>\`;

    return \`
      <div class="section-title">COMPARATIVE ANALYSIS</div>
      <div class="results-grid">
        <div class="result-card greenlib">
          <div class="result-card-header">🔬 GREENLIB ROUTE</div>
          <table class="result-table">
            <tr><td>Ni Value (\${(recovery.nico*100).toFixed(0)}% recovery, \${(greenlibPayability*100).toFixed(0)}% payable)</td><td>\${usd0(gl.ni)}/t</td></tr>
            <tr><td>Co Value (\${(recovery.nico*100).toFixed(0)}% recovery, \${(greenlibPayability*100).toFixed(0)}% payable)</td><td>\${usd0(gl.co)}/t</td></tr>
            <tr><td>Li₂CO₃ Value (\${(recovery.li*100).toFixed(0)}% recovery)</td><td>\${usd0(gl.li)}/t</td></tr>
            <tr><td>Graphite Value (\${(recovery.c*100).toFixed(0)}% recovery)</td><td>\${usd0(gl.graph)}/t</td></tr>
            <tr><td>LiF + Al/Cu Value</td><td>\${usd0(gl.lif + gl.al + gl.cu)}/t</td></tr>
            <tr><td><strong>Gross Product Value</strong></td><td><strong>\${usd0(gl.gross)}/t</strong></td></tr>
            <tr><td>Processing Fee</td><td>-\${usd0(fees.processing)}/t</td></tr>
            <tr><td>Capacity Reservation</td><td>-\${usd0(fees.capacity)}/t</td></tr>
            <tr><td>All-in logistics and compliance</td><td>-\${usd0(fees.greenlibTransport)}/t</td></tr>
            <tr><td><strong>NET REALIZATION</strong></td><td><strong>\${usd0(glNet)}/t</strong></td></tr>
          </table>
        </div>
        <div class="result-card export">
          <div class="result-card-header">📦 EXPORT ROUTE (BASELINE)</div>
          <table class="result-table">
            <tr><td>Ni Value (\${(exportParams.payability*100).toFixed(0)}% payable)</td><td>\${usd0(ex.niV)}/t</td></tr>
            <tr><td>Co Value (\${(exportParams.payability*100).toFixed(0)}% payable)</td><td>\${usd0(ex.coV)}/t</td></tr>
            <tr><td><strong>Gross Product Value</strong></td><td><strong>\${usd0(ex.gross)}/t</strong></td></tr>
            <tr><td>All-in logistics and compliance (CIF Asia)</td><td>-\${usd0(exportParams.transport)}/t</td></tr>
            <tr><td><strong>NET REALIZATION</strong></td><td><strong>\${usd0(ex.net)}/t</strong></td></tr>
          </table>
        </div>
      </div>

      <div class="improvement-banner">
        <h2>💰 VALUE ENHANCEMENT</h2>
        <div class="improvement-amount">\${usd0(improvement)} per tonne</div>
        <div class="improvement-details">
          <p><strong>Total Annual Benefit:</strong> \${usd0(totalImprovement)} (\${num0(volume)} tonnes)</p>
          <p><strong>Improvement:</strong> \${Number.isFinite(improvementPct) ? improvementPct.toFixed(1) + '%' : 'N/A'} vs Asia Export</p>
        </div>
      </div>

      <div class="projection-card">
        <h3>📈 5-YEAR CUMULATIVE FINANCIAL PROJECTION</h3>
        <table class="projection-table">
          <thead><tr><th>Year</th><th>Annual Volume (tonnes)</th><th>Improvement per Tonne</th><th>Annual Benefit</th><th>Cumulative Benefit</th></tr></thead>
          <tbody>
            \${[1,2,3,4,5].map(i => \`<tr><td>Year \${i}</td><td>\${num0(volume)}</td><td>\${usd0(improvement)}</td><td>\${usd0(totalImprovement)}</td><td>\${usd0(totalImprovement*i)}</td></tr>\`).join('')}
            <tr><td><strong>TOTAL 5-YEAR BENEFIT</strong></td><td colspan="3"></td><td><strong>\${usd0(totalImprovement*5)}</strong></td></tr>
          </tbody>
        </table>
      </div>

      <div class="price-scenarios">
        \${['bear','base','bull'].map(name => {
          const scenMap = { bear:{ni:12000,co:30000,li:5000}, base:{ni:prices.ni,co:prices.co,li:prices.li}, bull:{ni:20000,co:55000,li:12000} };
          const label = name==='bear' ? '🐻 BEAR CASE' : (name==='base' ? '📊 BASE CASE' : '🚀 BULL CASE');
          const s = scenMap[name];
          const prices2 = { ...prices, ni:s.ni, co:s.co, li:s.li };
          const gl2 = greenlibGrossAt({ prices: prices2, content, recovery, greenlibPayability });
          const net2 = greenlibNetAt(gl2.gross, fees, 0);
          const ex2 = exportNetAt({ content, prices: prices2, exportParams });
          return \`<div class="scenario-card \${name}">
            <h4>\${label}</h4>
            <div class="scenario-metric"><span>Ni:</span><span>\${usd0(s.ni)}/t</span></div>
            <div class="scenario-metric"><span>Co:</span><span>\${usd0(s.co)}/t</span></div>
            <div class="scenario-metric"><span>Li:</span><span>\${usd0(s.li)}/t</span></div>
            <div class="scenario-metric"><span>GreenLIB Net:</span><span>\${usd0(net2)}/t</span></div>
            <div class="scenario-metric"><span>Export Net:</span><span>\${usd0(ex2.net)}/t</span></div>
          </div>\`;
        }).join('')}
      </div>

      \${formulaDetails}
    \`;
  }

  function wireButtons() {
    document.getElementById('btn-us1')?.addEventListener('click', () => {
      checkComposition('us1'); const state = readParams('us1');
      document.getElementById('us1-results').innerHTML = buildUS1Results(state); saveInputs();
    });
    document.getElementById('btn-us2')?.addEventListener('click', () => {
      checkComposition('us2'); const state = readParams('us2');
      document.getElementById('us2-results').innerHTML = buildUS2Results(state); saveInputs();
    });
    document.getElementById('btn-eu')?.addEventListener('click', () => {
      checkComposition('eu'); const state = readParams('eu');
      document.getElementById('eu-results').innerHTML = buildEUResults(state); saveInputs();
    });
  }

  function init() {
    applyPercentConstraints();
    addAriaLabels();
    loadInputs();
    initTabs();
    wireButtons();
    // Auto-calc active tab initially
    document.getElementById('btn-us1')?.click();
    document.addEventListener('input', (e) => {
      if (e.target.matches('input[type="number"], select')) saveInputs();
    });
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>
